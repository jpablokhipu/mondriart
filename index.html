<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Mondriart - Prompt Artist v3.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #e5ddd5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            height: 90vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header tipo WhatsApp */
        .chat-header {
            background: #075e54;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .agent-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            overflow: hidden;
        }

        .agent-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scale(1.15);
        }

        .agent-info h2 {
            font-size: 1.1em;
            margin-bottom: 2px;
        }

        .agent-status {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* √Årea de mensajes */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23ece5dd" width="100" height="100"/></svg>');
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Burbujas de mensajes */
        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.agent {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.agent .message-bubble {
            background: white;
            border-radius: 0 8px 8px 8px;
        }

        .message.user .message-bubble {
            background: #dcf8c6;
            border-radius: 8px 0 8px 8px;
        }

        .message-content {
            color: #303030;
            line-height: 1.5;
            font-size: 0.95em;
        }

        .message-time {
            font-size: 0.7em;
            color: #667781;
            text-align: right;
            margin-top: 4px;
        }

        .message-label {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: auto;
        }

        .examples-inline {
            color: #888;
            font-style: italic;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-text {
            color: #667781;
            font-size: 0.9em;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #90949c;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Mensaje de validaci√≥n */
        .validation-message {
            color: #d14836;
            font-size: 0.85em;
            margin-top: 8px;
            padding: 8px 12px;
            background: #ffebee;
            border-radius: 8px;
            border-left: 3px solid #d14836;
        }

        /* Botones de elecci√≥n */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .choice-btn {
            padding: 12px 16px;
            border: 2px solid #075e54;
            background: white;
            color: #075e54;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .choice-btn:hover {
            background: #075e54;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .choice-btn-description {
            font-size: 0.85em;
            font-weight: 400;
            margin-top: 4px;
            opacity: 0.8;
        }

        /* Input area */
        .input-area {
            background: #f0f0f0;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #ddd;
        }

        .input-wrapper {
            flex: 1;
            background: white;
            border-radius: 24px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.95em;
            font-family: inherit;
        }

        .send-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #075e54;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .send-button:hover {
            background: #064e46;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* Confirmation screen */
        .confirmation-screen {
            display: none;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            background: #fff9e6;
            border-radius: 8px;
            margin: 10px 0;
        }

        .confirmation-screen.active {
            display: flex;
        }

        .confirmation-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .confirmation-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .confirmation-item:last-child {
            border-bottom: none;
        }

        .confirmation-label {
            font-weight: 600;
            color: #667eea;
            font-size: 0.85em;
        }

        .confirmation-value {
            color: #555;
            margin-top: 3px;
            font-size: 0.9em;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #075e54;
            color: white;
        }

        .action-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Result display */
        .result-box {
            background: white;
            border: 2px solid #075e54;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .result-title {
            font-weight: 600;
            color: #075e54;
            margin-bottom: 10px;
        }

        .prompt-text {
            color: #333;
            line-height: 1.6;
            font-size: 0.9em;
            white-space: pre-line;
        }

        .copy-button {
            background: #075e54;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
        }

        .copy-button:hover {
            background: #064e46;
        }

        /* Scrollbar styling */
        .messages-area::-webkit-scrollbar {
            width: 6px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 3px;
        }

        .messages-area::-webkit-scrollbar-thumb:hover {
            background: #999999;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            .chat-container {
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="agent-avatar">
                <img src="avatar.jpg" alt="Mondriart">
            </div>
            <div class="agent-info">
                <h2>Mondriart</h2>
                <div class="agent-status">Prompt Artist v3.1</div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-area" id="messagesArea">
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <span class="typing-text">Mondriart est√° escribiendo</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="messageInput" placeholder="Escribe tu respuesta..." disabled>
            </div>
            <button class="send-button" id="sendButton" disabled>
                ‚û§
            </button>
        </div>
    </div>

    <script>
        // Estado de la conversaci√≥n
        let currentStep = 0;
        let answers = {};
        let subjectCategory = 'general';

        // Preguntas adaptativas seg√∫n contexto
        const questionsTemplates = {
            sujeto: {
                label: 'Sujeto',
                question: '<strong>¬øQu√© quieres crear?</strong><br><span class="examples-inline">(Ej.: una bailarina de ballet, un paisaje urbano, un coche deportivo... ¬°lo que se te ocurra!)</span>',
                key: 'sujeto'
            },
            accion: {
                persona: {
                    label: 'Acci√≥n',
                    question: '<strong>¬øQu√© est√° haciendo?</strong><br><span class="examples-inline">(Ej.: saltando en el aire, posando elegantemente, ajust√°ndose el vestuario... ¬°Expl√°yate con total libertad!)</span>',
                    key: 'accion'
                },
                paisaje: {
                    label: 'Acci√≥n',
                    question: '<strong>¬øQu√© est√° ocurriendo?</strong><br><span class="examples-inline">(Ej.: tormenta el√©ctrica en desarrollo, atardecer tranquilo, neblina densa envolvente... ¬°Expl√°yate con total libertad!)</span>',
                    key: 'accion'
                },
                objeto: {
                    label: 'Acci√≥n',
                    question: '<strong>¬øEn qu√© estado est√°?</strong><br><span class="examples-inline">(Ej.: en reposo sobre una superficie, en movimiento din√°mico, flotando en el espacio... ¬°Expl√°yate con total libertad!)</span>',
                    key: 'accion'
                },
                general: {
                    label: 'Acci√≥n',
                    question: '<strong>¬øQu√© est√° pasando?</strong><br><span class="examples-inline">(Ej.: movimiento intenso, quietud absoluta, elementos en transformaci√≥n... ¬°Expl√°yate con total libertad!)</span>',
                    key: 'accion'
                }
            },
            entorno: {
                persona: {
                    label: 'Entorno',
                    question: '<strong>¬øD√≥nde est√°?</strong><br><span class="examples-inline">(Ej.: espacio amplio y luminoso, lugar cerrado e √≠ntimo, ambiente urbano transitado... S√© lo m√°s descriptivo que puedas con esto.)</span>',
                    key: 'entorno'
                },
                paisaje: {
                    label: 'Entorno',
                    question: '<strong>¬øC√≥mo es el lugar?</strong><br><span class="examples-inline">(Ej.: lugar concurrido, vista despejada, espacio natural abierto... S√© lo m√°s descriptivo que puedas con esto.)</span>',
                    key: 'entorno'
                },
                objeto: {
                    label: 'Entorno',
                    question: '<strong>¬øQu√© hay alrededor?</strong><br><span class="examples-inline">(Ej.: fondo minimalista, espacio abierto, ambiente con profundidad... S√© lo m√°s descriptivo que puedas con esto.)</span>',
                    key: 'entorno'
                },
                general: {
                    label: 'Entorno',
                    question: '<strong>¬øC√≥mo te imaginas el entorno de la escena?</strong><br><span class="examples-inline">(Ej.: ambiente urbano, espacio natural, entorno abstracto... S√© lo m√°s descriptivo que puedas con esto.)</span>',
                    key: 'entorno'
                }
            },
            estilo: {
                label: 'Estilo',
                question: '<strong>¬øQu√© estilo te gustar√≠a darle?</strong><br><span class="examples-inline">(Ej.: fotograf√≠a profesional con luz natural, ilustraci√≥n digital colorida, render 3D hiperrealista...)</span>',
                key: 'estilo_iluminacion'
            },
            detalles: {
                persona: {
                    label: 'Detalles',
                    question: '<strong>¬øQu√© caracter√≠sticas f√≠sicas destacan?</strong><br><span class="examples-inline">(Ej.: cabello recogido, vestuario de colores espec√≠ficos, expresi√≥n particular... Puedes combinar varias.)</span>',
                    key: 'detalles'
                },
                paisaje: {
                    label: 'Detalles',
                    question: '<strong>¬øQu√© elementos visuales destacan?</strong><br><span class="examples-inline">(Ej.: neblina baja, colores c√°lidos, texturas naturales... Puedes combinar varias.)</span>',
                    key: 'detalles'
                },
                objeto: {
                    label: 'Detalles',
                    question: '<strong>¬øQu√© detalles del objeto resaltar?</strong><br><span class="examples-inline">(Ej.: reflejos met√°licos, tonos o colores espec√≠ficos, acabados pulidos... Puedes combinar varias.)</span>',
                    key: 'detalles'
                },
                general: {
                    label: 'Detalles',
                    question: '<strong>¬øQu√© caracter√≠sticas espec√≠ficas tendr√°?</strong><br><span class="examples-inline">(Ej.: texturas particulares, paleta de colores, elementos destacados... Puedes combinar varias.)</span>',
                    key: 'detalles'
                }
            }
        };

        // Funci√≥n para detectar categor√≠a del sujeto
        function detectSubjectCategory(sujetoText) {
            const texto = sujetoText.toLowerCase();

            // Detectar persona/personaje
            const personaKeywords = ['persona', 'mujer', 'hombre', 'ni√±o', 'ni√±a', 'bailarina', 'bailar√≠n',
                                     'retrato', 'modelo', 'artista', 'atleta', 'profesional', 'anciano',
                                     'joven', 'chef', 'm√∫sico', 'actor', 'actriz'];
            if (personaKeywords.some(kw => texto.includes(kw))) {
                return 'persona';
            }

            // Detectar paisaje/escena
            const paisajeKeywords = ['paisaje', 'ciudad', 'urbano', 'playa', 'monta√±a', 'bosque',
                                     'calle', 'parque', 'jard√≠n', 'valle', 'desierto', 'oc√©ano',
                                     'atardecer', 'amanecer', 'naturaleza', 'escena'];
            if (paisajeKeywords.some(kw => texto.includes(kw))) {
                return 'paisaje';
            }

            // Detectar objeto/producto
            const objetoKeywords = ['coche', 'auto', 'reloj', 'producto', 'objeto', 'tel√©fono',
                                   'zapato', 'botella', 'comida', 'plato', 'joya', 'mueble',
                                   'dispositivo', 'instrumento', 'herramienta', 'veh√≠culo'];
            if (objetoKeywords.some(kw => texto.includes(kw))) {
                return 'objeto';
            }

            return 'general';
        }

        // Funci√≥n para obtener la pregunta contextual
        function getContextualQuestion(step) {
            if (step === 0) {
                return questionsTemplates.sujeto;
            } else if (step === 1) {
                return questionsTemplates.accion[subjectCategory];
            } else if (step === 2) {
                return questionsTemplates.entorno[subjectCategory];
            } else if (step === 3) {
                return questionsTemplates.estilo;
            } else if (step === 4) {
                return questionsTemplates.detalles[subjectCategory];
            }
        }

        // Referencias DOM
        const messagesArea = document.getElementById('messagesArea');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        // Funciones de utilidad
        function scrollToBottom() {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' +
                   now.getMinutes().toString().padStart(2, '0');
        }

        function addMessage(content, isUser = false, hasLabel = false, label = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'agent'}`;

            let messageHTML = '<div class="message-bubble">';

            if (hasLabel) {
                messageHTML += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <div class="message-label">${label}</div>
                </div>`;
            }

            messageHTML += `<div class="message-content">${content}</div>`;

            messageHTML += `<div class="message-time">${getCurrentTime()}</div>`;
            messageHTML += '</div>';

            messageDiv.innerHTML = messageHTML;
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTyping() {
            typingIndicator.classList.add('active');
            scrollToBottom();
        }

        function hideTyping() {
            typingIndicator.classList.remove('active');
        }

        function enableInput() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        function disableInput() {
            messageInput.disabled = true;
            sendButton.disabled = true;
        }

        function askQuestion(index) {
            if (index >= 5) {
                // FASE 1.5: Analizar completitud antes de generar
                const analysis = analyzeCompleteness();
                console.log('An√°lisis de completitud:', analysis);

                // Solo mostrar pregunta #6 si faltan 2 o m√°s elementos importantes
                if (analysis.missing.length >= 2) {
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        const questionMessage = `
                            <strong>¬øQuieres agregar algo m√°s?</strong><br>
                            <span class="examples-inline">(Ej.: tipo de iluminaci√≥n, plano abierto o cerrado, atm√≥sfera dram√°tica o serena, etc.)</span>
                            <div style="margin-top: 12px;">
                                <button class="choice-btn" onclick="generatePromptDirectly()" style="width: 100%; margin-bottom: 10px;">
                                    ‚ú® Generar prompt tal como est√°
                                </button>
                            </div>
                        `;
                        addMessage(questionMessage, false, true, 'Extras');

                        // Marcar que estamos en pregunta 6
                        currentStep = 6;
                        enableInput();
                    }, 700);
                } else {
                    // Generar directamente si est√° completo o solo falta 1 elemento
                    generatePrompt();
                }
                return;
            }

            const q = getContextualQuestion(index);

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage(q.question, false, true, q.label);
                enableInput();
            }, 700);
        }

        function validateResponse(text) {
            const words = text.trim().split(/\s+/).filter(w => w.length > 0);

            if (words.length < 2) {
                return {
                    valid: false,
                    message: 'Tu respuesta es muy breve. Intenta dar m√°s detalles para un mejor resultado (al menos 2-3 palabras).'
                };
            }

            return { valid: true };
        }

        // FASE 1.5: An√°lisis de completitud del prompt
        function analyzeCompleteness() {
            const analysis = {
                hasStyle: false,
                hasLighting: false,
                hasColors: false,
                hasComposition: false,
                hasMood: false
            };

            // Analizar todas las respuestas juntas
            const allText = Object.values(answers).join(' ').toLowerCase();

            // Detectar estilo
            const styleKeywords = ['fotograf√≠a', 'foto', 'ilustraci√≥n', 'ilustrado', 'render', '3d', 'pintura', 'digital', 'acuarela', '√≥leo', 'dibujo', 'arte'];
            analysis.hasStyle = styleKeywords.some(kw => allText.includes(kw));

            // Detectar iluminaci√≥n
            const lightKeywords = ['luz', 'iluminaci√≥n', 'iluminado', 'iluminada', 'oscuro', 'brillante', 'amanecer', 'atardecer', 'noche', 'd√≠a', 'sombra', 'reflejo', 'dorada', 'suave', 'dram√°tica'];
            analysis.hasLighting = lightKeywords.some(kw => allText.includes(kw));

            // Detectar colores
            const colorKeywords = ['rojo', 'azul', 'verde', 'amarillo', 'negro', 'blanco', 'dorado', 'plateado', 'coral', 'turquesa', 'color', 'colores', 'tono', 'tonos', 'paleta', 'c√°lido', 'fr√≠o', 'vibrante'];
            analysis.hasColors = colorKeywords.some(kw => allText.includes(kw));

            // Detectar composici√≥n
            const compositionKeywords = ['fondo', 'primer plano', 'encuadre', '√°ngulo', 'perspectiva', 'desenfoque', 'bokeh', 'profundidad', 'campo'];
            analysis.hasComposition = compositionKeywords.some(kw => allText.includes(kw));

            // Detectar mood/atm√≥sfera
            const moodKeywords = ['dram√°tico', 'sereno', 'alegre', 'melanc√≥lico', 'misterioso', 'vibrante', 'tranquilo', 'energ√©tico', 'atm√≥sfera', 'mood', 'ambiente'];
            analysis.hasMood = moodKeywords.some(kw => allText.includes(kw));

            // Identificar qu√© falta
            const missing = [];
            if (!analysis.hasStyle) missing.push('estilo art√≠stico');
            if (!analysis.hasLighting) missing.push('iluminaci√≥n');
            if (!analysis.hasColors) missing.push('colores espec√≠ficos');
            if (!analysis.hasComposition) missing.push('encuadre de la imagen');
            if (!analysis.hasMood) missing.push('una atm√≥sfera particular');

            return {
                complete: missing.length === 0,
                missing: missing,
                analysis: analysis
            };
        }

        function showDetailedResponseOptions(fullDescription) {
            const optionsMessage = `
                <div style="margin-bottom: 10px;">
                    Veo que diste bastante informaci√≥n detallada. ¬øC√≥mo prefieres continuar?
                </div>
                <div class="choice-buttons">
                    <button class="choice-btn" onclick="continueGuidedFlow()">
                        üìù Gu√≠ame con preguntas
                        <div class="choice-btn-description">Te har√© preguntas espec√≠ficas para refinar cada aspecto</div>
                    </button>
                    <button class="choice-btn" onclick="tryGenerateDirectly()">
                        ‚ö° Genera el prompt ahora
                        <div class="choice-btn-description">Intentar√© crear el prompt con la informaci√≥n que diste</div>
                    </button>
                </div>
            `;

            addMessage(optionsMessage, false);
        }

        // FASE 1.5: Pregunta condicional #6
        function generatePromptDirectly() {
            // Ocultar bot√≥n
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(b => b.style.display = 'none');

            // Deshabilitar input
            disableInput();

            // Agregar respuesta del usuario
            addMessage('Generar prompt tal como est√°', true);

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage("Perfecto, voy a crear tu prompt...", false);

                setTimeout(() => {
                    generatePrompt();
                }, 800);
            }, 600);
        }

        function continueGuidedFlow() {
            // Ocultar botones
            const buttons = document.querySelectorAll('.choice-buttons');
            buttons.forEach(b => b.style.display = 'none');

            // Agregar respuesta del usuario como si hubiera elegido
            addMessage('Prefiero el flujo guiado', true);

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage("Perfecto, entonces vamos paso a paso para refinar cada detalle. Ahora...", false);

                // Continuar con la siguiente pregunta
                currentStep++;
                setTimeout(() => {
                    askQuestion(currentStep);
                }, 400);
            }, 600);
        }

        function tryGenerateDirectly() {
            // Ocultar botones
            const buttons = document.querySelectorAll('.choice-buttons');
            buttons.forEach(b => b.style.display = 'none');

            // Agregar respuesta del usuario
            addMessage('Genera el prompt ahora', true);

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage("‚ú® Perfecto, voy a analizar tu descripci√≥n y crear el prompt...", false);

                // Generar prompt directamente desde la descripci√≥n completa
                setTimeout(() => {
                    generatePromptFromFullDescription();
                }, 800);
            }, 600);
        }

        function generatePromptFromFullDescription() {
            // Usar la descripci√≥n completa del sujeto como base
            const fullDescription = answers.sujeto;

            // CORRECCI√ìN ORTOGR√ÅFICA: Aplicar antes de capitalizar
            const descripcionCorregida = correctSpelling(fullDescription);

            // Capitalizar inicio del prompt (reglas del castellano)
            const promptCapitalizado = descripcionCorregida.charAt(0).toUpperCase() + descripcionCorregida.slice(1);

            // El prompt es la descripci√≥n refinada en estilo narrativo Nanobanana
            // May√∫scula despu√©s de punto
            const prompt = `${promptCapitalizado}. Imagen de alta calidad con atenci√≥n a los detalles sutiles, composici√≥n profesional y atm√≥sfera envolvente.`;

            const resultHTML = `
                <div class="result-title">‚ú® Tu Prompt Generado</div>
                <div class="result-box">
                    <div class="prompt-text">${prompt}</div>
                    <div style="margin-top: 12px; font-size: 0.85em; color: #667781; font-style: italic;">
                        Optimizado para Nanobanana/Gemini ‚Ä¢ Tambi√©n funciona en DALL-E y otros modelos
                    </div>
                    <button class="copy-button" onclick="copyPrompt()">üìã Copiar Prompt</button>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="copy-button" onclick="location.reload()" style="background: #667781;">üîÑ Crear Otro Prompt</button>
                </div>
            `;

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage(resultHTML, false);
            }, 1000);
        }

        function showValidationMessage(message) {
            const existingValidation = document.querySelector('.validation-message');
            if (existingValidation) {
                existingValidation.remove();
            }

            const inputArea = document.querySelector('.input-area');
            const validationDiv = document.createElement('div');
            validationDiv.className = 'validation-message';
            validationDiv.textContent = message;
            inputArea.parentNode.insertBefore(validationDiv, inputArea);

            setTimeout(() => {
                validationDiv.style.transition = 'opacity 0.3s';
                validationDiv.style.opacity = '0';
                setTimeout(() => validationDiv.remove(), 300);
            }, 3000);
        }

        function handleUserResponse() {
            const userAnswer = messageInput.value.trim();

            if (!userAnswer) {
                return;
            }

            // Validar longitud de respuesta
            const validation = validateResponse(userAnswer);
            if (!validation.valid) {
                showValidationMessage(validation.message);
                return;
            }

            // Agregar respuesta del usuario
            addMessage(userAnswer, true);

            // Guardar respuesta
            if (currentStep === 6) {
                // Pregunta #6 especial (extras)
                answers.extras = userAnswer;
            } else {
                // Preguntas normales (0-4)
                const currentQuestion = getContextualQuestion(currentStep);
                answers[currentQuestion.key] = userAnswer;
            }

            // Detectar categor√≠a despu√©s de la primera respuesta (sujeto)
            if (currentStep === 0) {
                subjectCategory = detectSubjectCategory(userAnswer);
                console.log('Categor√≠a detectada:', subjectCategory);

                // FASE 1: Detecci√≥n simple de respuestas largas
                const wordCount = userAnswer.split(/\s+/).filter(w => w.length > 0).length;
                if (wordCount > 20) {
                    // Limpiar input
                    messageInput.value = '';
                    disableInput();

                    // Mostrar opciones
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        showDetailedResponseOptions(userAnswer);
                    }, 600);
                    return; // Detener flujo normal
                }
            }

            // Limpiar input
            messageInput.value = '';
            disableInput();

            // FASE 1.5: Manejar respuesta de pregunta #6 (extras)
            if (currentStep === 6) {
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    addMessage("‚ú® Genial, ahora s√≠ tenemos todo. Voy a crear tu prompt...", false);

                    setTimeout(() => {
                        generatePrompt();
                    }, 800);
                }, 600);
                return;
            }

            // Comentario contextual del agente seg√∫n la pregunta actual
            const contextualComments = [
                "Perfecto, ese ser√° el elemento principal de tu imagen. Ahora...",
                "Entendido, esto ayudar√° a determinar la actividad de la escena. Siguiente...",
                "Genial, ya tengo el contexto espacial. Continuemos...",
                "Excelente, eso define el mood y la est√©tica visual. Y por √∫ltimo...",
                "‚ú® Perfecto, con esos detalles completamos tu visi√≥n. Dame un momento para crear tu prompt..."
            ];
            const contextualComment = contextualComments[currentStep];

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage(contextualComment, false);

                // Siguiente pregunta
                currentStep++;
                setTimeout(() => {
                    askQuestion(currentStep);
                }, 400);
            }, 600);
        }


        function parseEstiloIluminacion(text) {
            const lowerText = text.toLowerCase();
            let estilo = text;
            let iluminacion = "iluminaci√≥n natural";

            // Intentar separar estilo e iluminaci√≥n si menciona palabras clave
            if (lowerText.includes('luz') || lowerText.includes('iluminaci√≥n') || lowerText.includes('iluminado')) {
                // Buscar separadores comunes: "con", "y", ","
                const separatorMatch = text.match(/(.+?)\s+(con|y|,)\s+(.+)/i);
                if (separatorMatch) {
                    estilo = separatorMatch[1].trim();
                    iluminacion = separatorMatch[3].trim();
                } else {
                    // Si menciona luz pero no hay separador claro, todo es iluminaci√≥n
                    iluminacion = text;

                    // Inferir estilo b√°sico si menciona fotograf√≠a/ilustraci√≥n/render
                    if (lowerText.includes('fotograf')) {
                        estilo = "fotograf√≠a";
                    } else if (lowerText.includes('ilustr')) {
                        estilo = "ilustraci√≥n";
                    } else if (lowerText.includes('render') || lowerText.includes('3d')) {
                        estilo = "render 3D";
                    } else {
                        estilo = "imagen";
                    }
                }
            } else {
                // No menciona iluminaci√≥n expl√≠citamente
                // Solo usar el texto como estilo, iluminaci√≥n queda gen√©rica
                estilo = text;
                iluminacion = "iluminaci√≥n natural";
            }

            return { estilo, iluminacion };
        }

        // Funci√≥n de correcci√≥n ortogr√°fica autom√°tica
        function correctSpelling(text) {
            if (!text) return text;

            // Diccionario de correcciones de tildes m√°s comunes
            const accentCorrections = {
                // Palabras comunes
                'acion': 'acci√≥n', 'camara': 'c√°mara', 'musica': 'm√∫sica', 'fotografia': 'fotograf√≠a',
                'fotogr√°fica': 'fotogr√°fica', 'fotografico': 'fotogr√°fico', 'clasico': 'cl√°sico',
                'dramatico': 'dram√°tico', 'magico': 'm√°gico', 'mistico': 'm√≠stico', 'dinamico': 'din√°mico',
                'estatico': 'est√°tico', 'energico': 'en√©rgico', 'melancolico': 'melanc√≥lico',
                'cinematografico': 'cinematogr√°fico', 'atmosfera': 'atm√≥sfera', 'estetico': 'est√©tico',
                // Adjetivos
                'rapido': 'r√°pido', 'rapida': 'r√°pida', 'suave': 'suave', 'intima': '√≠ntima', 'intimo': '√≠ntimo',
                'util': '√∫til', 'facil': 'f√°cil', 'dificil': 'dif√≠cil', 'arido': '√°rido', 'arida': '√°rida',
                'solido': 's√≥lido', 'solida': 's√≥lida', 'liquido': 'l√≠quido', 'liquida': 'l√≠quida',
                'calido': 'c√°lido', 'calida': 'c√°lida', 'humedo': 'h√∫medo', 'humeda': 'h√∫meda',
                'arido': '√°rido', 'rigido': 'r√≠gido', 'rigida': 'r√≠gida', 'timido': 't√≠mido', 'timida': 't√≠mida',
                // Acciones y verbos
                'esta': 'est√°', 'estas': 'est√°s', 'estan': 'est√°n', 'estaba': 'estaba', 'estaran': 'estar√°n',
                'sera': 'ser√°', 'seran': 'ser√°n', 'hara': 'har√°', 'haran': 'har√°n',
                'camina': 'camina', 'caminando': 'caminando', 'saltando': 'saltando',
                'corriendo': 'corriendo', 'bailando': 'bailando', 'volando': 'volando',
                // Lugares y espacios
                'edificio': 'edificio', 'jardin': 'jard√≠n', 'salon': 'sal√≥n', 'habitacion': 'habitaci√≥n',
                '√°tico': '√°tico', 'atico': '√°tico', 'sotano': 's√≥tano', 'almacen': 'almac√©n',
                'arbol': '√°rbol', 'arboles': '√°rboles', 'cesped': 'c√©sped', 'avion': 'avi√≥n',
                // Colores y tonos
                'palido': 'p√°lido', 'palida': 'p√°lida', 'vivido': 'v√≠vido', 'vivida': 'v√≠vida',
                'solido': 's√≥lido', 'metalico': 'met√°lico', 'metalica': 'met√°lica',
                // Iluminaci√≥n
                'iluminacion': 'iluminaci√≥n', 'lampara': 'l√°mpara', 'neon': 'ne√≥n',
                'opaco': 'opaco', 'opaca': 'opaca', 'brillante': 'brillante', 'lucido': 'l√∫cido',
                // Tiempo
                'dia': 'd√≠a', 'manana': 'ma√±ana', 'mediodia': 'mediod√≠a', 'despues': 'despu√©s',
                'proximo': 'pr√≥ximo', 'proxima': 'pr√≥xima', 'ultimo': '√∫ltimo', 'ultima': '√∫ltima',
                // Emociones y estados
                'alegria': 'alegr√≠a', 'melancolia': 'melancol√≠a', 'armonia': 'armon√≠a',
                'pasion': 'pasi√≥n', 'emocion': 'emoci√≥n', 'tension': 'tensi√≥n', 'ilusion': 'ilusi√≥n',
                // T√©cnicas y estilos
                'oleo': '√≥leo', 'lapiz': 'l√°piz', 'acrilico': 'acr√≠lico', 'grafico': 'gr√°fico',
                'simetria': 'simetr√≠a', 'geometria': 'geometr√≠a', 'optica': '√≥ptica', 'optico': '√≥ptico',
                // Naturaleza
                'oceano': 'oc√©ano', 'rio': 'r√≠o', 'montana': 'monta√±a', 'volcan': 'volc√°n',
                'huracan': 'hurac√°n', 'relampago': 'rel√°mpago', 'petalos': 'p√©talos', 'petalo': 'p√©talo',
                // Personas
                'nino': 'ni√±o', 'nina': 'ni√±a', 'joven': 'joven', 'anciano': 'anciano', 'mujer': 'mujer',
                'musico': 'm√∫sico', 'medico': 'm√©dico', 'heroe': 'h√©roe', 'heroina': 'hero√≠na',
                // Objetos
                'vehiculo': 'veh√≠culo', 'helicoptero': 'helic√≥ptero', 'telefono': 'tel√©fono',
                'movil': 'm√≥vil', 'portatil': 'port√°til', 'comoda': 'c√≥moda', 'lampara': 'l√°mpara',
                // Texturas y materiales
                'aspero': '√°spero', 'aspera': '√°spera', 'poliester': 'poli√©ster', 'plastico': 'pl√°stico',
                // Otros
                'mas': 'm√°s', 'detras': 'detr√°s', 'tambien': 'tambi√©n', 'ademas': 'adem√°s',
                'asi': 'as√≠', 'aca': 'ac√°', 'alla': 'all√°', 'alla': 'all√°', 'aqui': 'aqu√≠', 'ahi': 'ah√≠',
                'tu': 't√∫', 'mi': 'm√≠', 'si': 's√≠', 'te': 't√©', 'el': '√©l', 'solo': 'solo', 'aun': 'a√∫n'
            };

            // Aplicar correcciones palabra por palabra
            let correctedText = text;

            // Usar l√≠mites de palabra para evitar correcciones parciales
            Object.keys(accentCorrections).forEach(wrong => {
                const correct = accentCorrections[wrong];
                // Crear regex con l√≠mites de palabra
                const regex = new RegExp('\\b' + wrong + '\\b', 'gi');
                correctedText = correctedText.replace(regex, correct);
            });

            return correctedText;
        }

        function generatePrompt() {
            showTyping();

            setTimeout(() => {
                hideTyping();

                // CORRECCI√ìN ORTOGR√ÅFICA: Aplicar a todas las respuestas
                const sujetoCorregido = correctSpelling(answers.sujeto);
                const accionCorregida = correctSpelling(answers.accion);
                const detallesCorregidos = correctSpelling(answers.detalles);
                const entornoCorregido = correctSpelling(answers.entorno);
                const estiloCorregido = correctSpelling(answers.estilo_iluminacion);
                const extrasCorregidas = answers.extras ? correctSpelling(answers.extras) : null;

                const { estilo, iluminacion } = parseEstiloIluminacion(estiloCorregido);

                // Generar prompt estilo Nanobanana: narrativa fluida en espa√±ol
                // Asegurar capitalizaci√≥n correcta seg√∫n reglas del castellano

                // Capitalizar inicio del prompt (sujeto - despu√©s de nada = may√∫scula)
                const sujetoCapitalizado = sujetoCorregido.charAt(0).toUpperCase() + sujetoCorregido.slice(1);

                // Min√∫scula para acci√≥n (va despu√©s del sujeto, sin punto previo)
                const accionMinuscula = accionCorregida.charAt(0).toLowerCase() + accionCorregida.slice(1);

                // Min√∫scula para detalles (va despu√©s de coma)
                const detallesMinuscula = detallesCorregidos.charAt(0).toLowerCase() + detallesCorregidos.slice(1);

                // Min√∫scula para entorno (va despu√©s de "en", sin punto previo)
                const entornoMinuscula = entornoCorregido.charAt(0).toLowerCase() + entornoCorregido.slice(1);

                // Capitalizar despu√©s de punto (estilo)
                const estiloCapitalizado = estilo.charAt(0).toUpperCase() + estilo.slice(1);

                // Min√∫scula para iluminaci√≥n (va despu√©s de "con")
                const iluminacionMinuscula = iluminacion.charAt(0).toLowerCase() + iluminacion.slice(1);

                // Construir prompt narrativo con ortograf√≠a correcta
                // May√∫sculas despu√©s de punto, min√∫sculas en otros contextos
                let prompt = `${sujetoCapitalizado} ${accionMinuscula}, con ${detallesMinuscula}. La escena se desarrolla en ${entornoMinuscula}. ${estiloCapitalizado} con ${iluminacionMinuscula}`;

                // FASE 1.5: Agregar informaci√≥n extra si existe (de pregunta #6)
                if (extrasCorregidas) {
                    // Capitalizar primera letra de extras si no empieza con min√∫scula intencionalmente
                    const extrasMinuscula = extrasCorregidas.charAt(0).toLowerCase() + extrasCorregidas.slice(1);
                    prompt += `, ${extrasMinuscula}`;
                }

                // Cierre natural del prompt
                prompt += `.`;

                const resultHTML = `
                    <div class="result-title">‚ú® Tu Prompt Generado</div>
                    <div class="result-box">
                        <div class="prompt-text">${prompt}</div>
                        <div style="margin-top: 12px; font-size: 0.85em; color: #667781; font-style: italic;">
                            Optimizado para Nanobanana/Gemini ‚Ä¢ Tambi√©n funciona en DALL-E y otros modelos
                        </div>
                        <button class="copy-button" onclick="copyPrompt()">üìã Copiar Prompt</button>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="restart()">Crear Nuevo Prompt</button>
                    </div>
                `;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message agent';
                messageDiv.innerHTML = `
                    <div class="message-bubble" style="max-width: 90%;">
                        ${resultHTML}
                    </div>
                `;

                messagesArea.appendChild(messageDiv);
                scrollToBottom();

                // Guardar el prompt generado
                window.generatedPrompt = prompt;
            }, 1500);
        }

        function copyPrompt() {
            if (window.generatedPrompt) {
                navigator.clipboard.writeText(window.generatedPrompt).then(() => {
                    alert('‚úÖ Prompt copiado al portapapeles');
                });
            }
        }

        function restart() {
            answers = {};
            currentStep = 0;
            subjectCategory = 'general';
            messagesArea.innerHTML = '';

            addMessage('¬°Hola! üëã Soy Mondriart. Te guiar√© con <strong>preguntas clave de prompting</strong> para crear un <strong>resultado coherente y profesional</strong> para usar en tu modelo de im√°genes favorito.', false);

            setTimeout(() => {
                askQuestion(0);
            }, 1000);
        }

        // Event listeners
        sendButton.addEventListener('click', handleUserResponse);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserResponse();
            }
        });

        // Iniciar conversaci√≥n
        window.addEventListener('load', () => {
            setTimeout(() => {
                addMessage('¬°Hola! üëã Soy Mondriart. Te guiar√© con <strong>preguntas clave de prompting</strong> para crear un <strong>resultado coherente y profesional</strong> para usar en tu modelo de im√°genes favorito.', false);
                setTimeout(() => {
                    askQuestion(0);
                }, 1500);
            }, 500);
        });
    </script>
</body>
</html>
